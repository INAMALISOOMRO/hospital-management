<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - User Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      background-color: #f5f6fa;
      color: #2d3436;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-left img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: white;
      padding: 8px;
      object-fit: contain;
    }

    .header-info h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header-info p {
      font-size: 14px;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-info {
      text-align: right;
    }

    .user-info .role-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      font-size: 12px;
      margin-top: 5px;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 10px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: white;
      color: #667eea;
    }

    .container {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 40px;
    }

    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .card-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }

    .card h3 {
      font-size: 16px;
      color: #636e72;
      margin-bottom: 10px;
    }

    .card .number {
      font-size: 36px;
      font-weight: 700;
      color: #2d3436;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .section-header h2 {
      font-size: 24px;
      color: #2d3436;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #ff6b6b;
      color: white;
    }

    .btn-danger:hover {
      background: #ff5252;
    }

    .btn-warning {
      background: #ffa502;
      color: white;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3436;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    table th,
    table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2d3436;
      font-size: 14px;
    }

    table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .role-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .role-admin {
      background: #ffe0e0;
      color: #c30000;
    }

    .role-reception {
      background: #d4f1f4;
      color: #006a75;
    }

    .role-medical {
      background: #d4e9ff;
      color: #0056b3;
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .action-btns button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 0 20px;
      }

      header {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="logo.png" alt="Hospital Logo" onerror="this.style.display='none'">
      <div class="header-info">
        <h1>Admin Dashboard</h1>
        <p>User Management System</p>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div id="currentUserName">Administrator</div>
        <span class="role-badge">ADMIN</span>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="container">
    <!-- Auto-Updater Section -->
    <div class="section">
      <div class="section-header">
        <h2>üîÑ Software Updates</h2>
      </div>
      
      <p style="color: #666; margin-bottom: 20px;">
        Keep your hospital management system up to date with the latest features and security improvements.
      </p>
      
      <button class="btn btn-primary" onclick="manualUpdateCheck()">
        üîÑ Check for Updates
      </button>
      
      <div id="updateStatus" class="alert" style="margin-top: 15px;"></div>
      
      <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <p style="margin: 5px 0; font-size: 14px;"><strong>Current Version:</strong> <span id="currentVersion">Loading...</span></p>
        <p style="margin: 5px 0; font-size: 14px;"><strong>Last Checked:</strong> <span id="lastChecked">Never</span></p>
        <p style="margin: 5px 0; font-size: 14px;"><strong>Auto-Update:</strong> <span style="color: #2e7d32;">‚úÖ Enabled</span></p>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="dashboard-cards">
      <div class="card">
        <div class="card-icon">üë•</div>
        <h3>Total Users</h3>
        <div class="number" id="totalUsers">0</div>
      </div>
      <div class="card">
        <div class="card-icon">‚úÖ</div>
        <h3>Active Users</h3>
        <div class="number" id="activeUsers">0</div>
      </div>
      <div class="card">
        <div class="card-icon">üè•</div>
        <h3>Reception Staff</h3>
        <div class="number" id="receptionCount">0</div>
      </div>
      <div class="card">
        <div class="card-icon">üíä</div>
        <h3>Medical Staff</h3>
        <div class="number" id="medicalCount">0</div>
      </div>
    </div>

    <!-- Create New User -->
    <div class="section">
      <div class="section-header">
        <h2>Create New User</h2>
      </div>

      <div class="alert alert-success" id="successAlert"></div>
      <div class="alert alert-error" id="errorAlert"></div>

      <form id="createUserForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="fullName">Full Name *</label>
            <input type="text" id="fullName" placeholder="Enter full name" required>
          </div>
          <div class="form-group">
            <label for="username">Username *</label>
            <input type="text" id="username" placeholder="Enter username" required>
          </div>
          <div class="form-group">
            <label for="password">Password *</label>
            <input type="password" id="password" placeholder="Enter password" required>
          </div>
          <div class="form-group">
            <label for="role">Role *</label>
            <select id="role" required>
              <option value="">-- Select Role --</option>
              <option value="admin">Admin (Full Access)</option>
              <option value="reception">Reception (Patient Management)</option>
              <option value="medical">Medical Store (Pharmacy)</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Create User</button>
      </form>
    </div>

    <!-- User List -->
    <div class="section">
      <div class="section-header">
        <h2>All Users</h2>
        <button class="btn btn-primary" onclick="loadUsers()">üîÑ Refresh</button>
      </div>

      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Username</th>
            <th>Role</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">Loading users...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let authDB;
    let currentUser = null;

    // Open database
    function openAuthDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('HospitalAuthDB', 1);
        
        request.onupgradeneeded = function(event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('users')) {
            const userStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
            userStore.createIndex('username', 'username', { unique: true });
          }
          if (!db.objectStoreNames.contains('sessions')) {
            db.createObjectStore('sessions', { keyPath: 'sessionId' });
          }
        };
        
        request.onsuccess = function(event) {
          authDB = event.target.result;
          resolve(authDB);
        };
        
        request.onerror = function(event) {
          reject(event.target.error);
        };
      });
    }

    // FIXED: Check authentication - CORRECT ROLE FOR ADMIN PAGE
    async function checkAuthentication() {
      const session = localStorage.getItem('currentSession');
      
      if (!session) {
        alert('Please login first');
        window.location.href = 'index.html?forceLogin=true';
        return null;
      }

      try {
        currentUser = JSON.parse(session);
        
        // CRITICAL FIX: This is admin.html, so check for 'admin' role
        const requiredRole = 'admin'; // Changed from 'reception' to 'admin'
        
        if (currentUser.role !== requiredRole) {
          alert('Access denied. You must be an administrator to access this page.');
          localStorage.clear();
          window.location.href = 'index.html?forceLogin=true';
          return null;
        }

        console.log('Admin logged in as:', currentUser.fullName, '(' + currentUser.role + ')');
        
        // Update header with current user info
        const userNameElement = document.getElementById('currentUserName');
        if (userNameElement) {
          userNameElement.textContent = currentUser.fullName;
        }
        
        return currentUser;
      } catch (error) {
        console.error('Session error:', error);
        localStorage.clear();
        window.location.href = 'index.html?forceLogin=true';
        return null;
      }
    }

    // Show alert
    function showAlert(type, message) {
      const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
      const alertDiv = document.getElementById(alertId);
      alertDiv.textContent = message;
      alertDiv.style.display = 'block';
      
      setTimeout(() => {
        alertDiv.style.display = 'none';
      }, 5000);
    }

    // Load statistics
    async function loadStatistics() {
      try {
        const db = await openAuthDB();
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.getAll();

        request.onsuccess = function() {
          const users = request.result || [];
          
          console.log('Loaded users for statistics:', users.length);
          
          document.getElementById('totalUsers').textContent = users.length;
          document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'active').length;
          document.getElementById('receptionCount').textContent = users.filter(u => u.role === 'reception').length;
          document.getElementById('medicalCount').textContent = users.filter(u => u.role === 'medical').length;
        };

        request.onerror = function() {
          console.error('Error loading statistics');
        };
      } catch (error) {
        console.error('Statistics error:', error);
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const db = await openAuthDB();
        const transaction = db.transaction(['users'], 'readonly');
        const store = transaction.objectStore('users');
        const request = store.getAll();

        request.onsuccess = function() {
          const users = request.result || [];
          const tbody = document.getElementById('usersTableBody');
          
          console.log('Loaded users for table:', users);
          
          if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No users found</td></tr>';
            return;
          }

          tbody.innerHTML = users.map(user => `
            <tr>
              <td>${user.id}</td>
              <td>${user.fullName}</td>
              <td>${user.username}</td>
              <td><span class="role-badge role-${user.role}">${user.role.toUpperCase()}</span></td>
              <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
              <td>${new Date(user.createdAt).toLocaleDateString()}</td>
              <td>
                <div class="action-btns">
                  ${user.status === 'active' 
                    ? `<button class="btn btn-warning" onclick="toggleUserStatus(${user.id}, 'inactive')">Deactivate</button>`
                    : `<button class="btn btn-primary" onclick="toggleUserStatus(${user.id}, 'active')">Activate</button>`
                  }
                  ${user.username !== 'admin' 
                    ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>`
                    : ''
                  }
                </div>
              </td>
            </tr>
          `).join('');
        };

        request.onerror = function() {
          console.error('Error loading users');
          const tbody = document.getElementById('usersTableBody');
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: red;">Error loading users</td></tr>';
        };
      } catch (error) {
        console.error('Load users error:', error);
      }
    }

    // Create user
    async function createUser(event) {
      event.preventDefault();

      const fullName = document.getElementById('fullName').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;

      if (!fullName || !username || !password || !role) {
        showAlert('error', 'Please fill in all fields');
        return;
      }

      if (password.length < 4) {
        showAlert('error', 'Password must be at least 4 characters');
        return;
      }

      try {
        const db = await openAuthDB();
        const transaction = db.transaction(['users'], 'readwrite');
        const store = transaction.objectStore('users');
        const index = store.index('username');
        
        // Check if username exists
        const checkRequest = index.get(username);
        
        checkRequest.onsuccess = function() {
          if (checkRequest.result) {
            showAlert('error', 'Username already exists');
            return;
          }

          // Create new user
          const newUser = {
            username,
            password,
            fullName,
            role,
            status: 'active',
            createdAt: new Date().toISOString(),
            createdBy: currentUser ? currentUser.userId : null
          };

          const addRequest = store.add(newUser);
          
          addRequest.onsuccess = function() {
            console.log('User created successfully:', newUser);
            showAlert('success', `User "${fullName}" created successfully!`);
            document.getElementById('createUserForm').reset();
            loadUsers();
            loadStatistics();
          };

          addRequest.onerror = function(e) {
            console.error('Add user error:', e);
            showAlert('error', 'Failed to create user. Please try again.');
          };
        };

        checkRequest.onerror = function(e) {
          console.error('Check username error:', e);
          showAlert('error', 'Error checking username. Please try again.');
        };

      } catch (error) {
        console.error('Create user error:', error);
        showAlert('error', 'An error occurred: ' + error.message);
      }
    }

    // Toggle user status
    async function toggleUserStatus(userId, newStatus) {
      if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this user?`)) {
        return;
      }

      try {
        const db = await openAuthDB();
        const transaction = db.transaction(['users'], 'readwrite');
        const store = transaction.objectStore('users');
        
        const getRequest = store.get(userId);
        
        getRequest.onsuccess = function() {
          const user = getRequest.result;
          if (!user) {
            showAlert('error', 'User not found');
            return;
          }
          
          user.status = newStatus;
          
          const updateRequest = store.put(user);
          
          updateRequest.onsuccess = function() {
            showAlert('success', `User ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            loadUsers();
            loadStatistics();
          };

          updateRequest.onerror = function() {
            showAlert('error', 'Failed to update user status');
          };
        };

        getRequest.onerror = function() {
          showAlert('error', 'Error retrieving user');
        };
      } catch (error) {
        console.error('Toggle status error:', error);
        showAlert('error', 'An error occurred');
      }
    }

    // Delete user
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }

      try {
        const db = await openAuthDB();
        const transaction = db.transaction(['users'], 'readwrite');
        const store = transaction.objectStore('users');
        
        const deleteRequest = store.delete(userId);
        
        deleteRequest.onsuccess = function() {
          showAlert('success', 'User deleted successfully');
          loadUsers();
          loadStatistics();
        };

        deleteRequest.onerror = function() {
          showAlert('error', 'Failed to delete user');
        };
      } catch (error) {
        console.error('Delete user error:', error);
        showAlert('error', 'An error occurred');
      }
    }

    // Logout
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear all storage
        localStorage.clear();
        sessionStorage.clear();
        
        // Redirect to login with force parameter
        window.location.href = 'index.html?forceLogin=true';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        console.log('Initializing admin dashboard...');
        
        // Initialize auto-updater if in Electron
        initAutoUpdater();
        
        // Open database first
        await openAuthDB();
        console.log('Database opened successfully');
        
        // Check authentication
        const user = await checkAuthentication();
        if (!user) {
          console.log('Authentication failed, redirecting...');
          return;
        }
        
        console.log('Authentication successful, loading data...');
        
        // Load users and statistics
        await loadUsers();
        await loadStatistics();
        
        // Attach form submit handler
        document.getElementById('createUserForm').addEventListener('submit', createUser);
        
        console.log('Admin dashboard initialized successfully');
      } catch (error) {
        console.error('Initialization error:', error);
        alert('Failed to initialize application: ' + error.message);
      }
    });

    // ============================================
    // AUTO-UPDATER FUNCTIONALITY
    // ============================================
    
    function initAutoUpdater() {
      try {
        // Check if running in Electron
        if (typeof require !== 'undefined') {
          const { app } = require('electron').remote || require('@electron/remote');
          const { ipcRenderer } = require('electron');
          
          // Display current version
          document.getElementById('currentVersion').textContent = app.getVersion();
          
          // Listen for update events from main process
          ipcRenderer.on('update-checking', () => {
            showUpdateStatus('üîç Checking for updates...', 'checking');
          });
          
          ipcRenderer.on('update-available', (event, info) => {
            showUpdateStatus(`üéâ New version ${info.version} is available! Downloading...`, 'available');
          });
          
          ipcRenderer.on('update-not-available', () => {
            showUpdateStatus('‚úÖ You are running the latest version!', 'uptodate');
          });
          
          ipcRenderer.on('download-progress', (event, progress) => {
            const percent = Math.round(progress.percent);
            const downloaded = (progress.transferred / 1024 / 1024).toFixed(2);
            const total = (progress.total / 1024 / 1024).toFixed(2);
            showUpdateStatus(`üì• Downloading update: ${percent}% (${downloaded}MB / ${total}MB)`, 'downloading');
          });
          
          ipcRenderer.on('update-downloaded', (event, info) => {
            showUpdateStatus('‚úÖ Update downloaded! Application will restart to install...', 'ready');
          });
          
          ipcRenderer.on('update-error', (event, error) => {
            showUpdateStatus('‚ùå Update error: ' + error, 'error');
          });
          
          console.log('Auto-updater initialized');
        } else {
          // Not in Electron - show version as N/A
          document.getElementById('currentVersion').textContent = 'N/A (Browser Mode)';
          console.log('Not running in Electron - auto-updater disabled');
        }
      } catch (error) {
        console.log('Auto-updater not available:', error);
        document.getElementById('currentVersion').textContent = 'N/A';
      }
    }
    
    // Show update status message
    function showUpdateStatus(message, type) {
      const statusDiv = document.getElementById('updateStatus');
      
      // Remove all previous classes
      statusDiv.className = 'alert';
      
      // Add appropriate class based on type
      if (type === 'checking' || type === 'downloading') {
        statusDiv.className = 'alert alert-info';
        statusDiv.style.background = '#e3f2fd';
        statusDiv.style.color = '#1976d2';
        statusDiv.style.borderLeft = '4px solid #1976d2';
      } else if (type === 'available') {
        statusDiv.className = 'alert alert-warning';
        statusDiv.style.background = '#fff3e0';
        statusDiv.style.color = '#f57c00';
        statusDiv.style.borderLeft = '4px solid #f57c00';
      } else if (type === 'ready' || type === 'uptodate') {
        statusDiv.className = 'alert alert-success';
      } else if (type === 'error') {
        statusDiv.className = 'alert alert-error';
      }
      
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Update last checked time for checking events
      if (type === 'checking') {
        document.getElementById('lastChecked').textContent = new Date().toLocaleString();
      }
      
      // Auto-hide success messages after 10 seconds
      if (type === 'uptodate') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 10000);
      }
    }
    
    // Manual update check
    async function manualUpdateCheck() {
      try {
        // Check if running in Electron
        if (typeof require === 'undefined') {
          showUpdateStatus('‚ö†Ô∏è Auto-update is only available in the desktop app version', 'error');
          return;
        }
        
        const { ipcRenderer } = require('electron');
        
        showUpdateStatus('üîç Checking for updates...', 'checking');
        
        const result = await ipcRenderer.invoke('check-for-updates');
        
        if (result.success) {
          // Wait for update events
          setTimeout(() => {
            // If no update found after 5 seconds, show up-to-date
            const statusDiv = document.getElementById('updateStatus');
            if (statusDiv.textContent.includes('Checking')) {
              showUpdateStatus('‚úÖ You are running the latest version!', 'uptodate');
            }
          }, 5000);
        } else {
          showUpdateStatus('‚ùå Update check failed: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Update check error:', error);
        showUpdateStatus('‚ö†Ô∏è Auto-update is only available in the desktop app version', 'error');
      }
    }
  </script>
</body>
</html>